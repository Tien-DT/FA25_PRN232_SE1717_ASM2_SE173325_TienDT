@page "/RentalsTienDts/RentalsTienDtForm/{id:int?}"
@using EVRental.BlazorWebApp.TienDT.Models
@using EVRental.BlazorWebApp.TienDT.GraphQLClients
@using System.Globalization
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject GraphQLConsumers GraphQLClient
@inject NavigationManager Navigation

<div class="rental-form-container">
	<div class="card">
		<div class="card-header">
			<h3>@(Id.HasValue ? "Chỉnh sửa thuê xe" : "Đăng ký thuê xe")</h3>
			<p class="subtitle">Nhập thông tin thuê xe — đơn giản, nhanh chóng và rõ ràng</p>
		</div>

		@if (!string.IsNullOrEmpty(errorMessage))
		{
			<div class="alert error">
				@errorMessage
			</div>
		}

		@if (isLoading)
		{
			<div class="loading">Đang tải...</div>
		}
		else
		{
			<EditForm Model="rental" OnValidSubmit="HandleValidSubmit">
				<DataAnnotationsValidator />
				
				@if (!string.IsNullOrEmpty(validationError))
				{
					<div class="alert error">
						@validationError
					</div>
				}

				<div class="card-body">
					<div class="grid">
						<div class="form-group">
							<label for="userAccount">Người thuê (UserAccountId) <span class="required">*</span></label>
							<InputNumber id="userAccount" class="input" @bind-Value="rental.UserAccountId" />
							<ValidationMessage For="@(() => rental.UserAccountId)" class="validation-message" />
						</div>

						<div class="form-group">
							<label for="vehicle">Xe (VehicleId) <span class="required">*</span></label>
							<InputNumber id="vehicle" class="input" @bind-Value="rental.VehicleId" />
							<ValidationMessage For="@(() => rental.VehicleId)" class="validation-message" />
						</div>

						<div class="form-group">
							<label for="station">Trạm (StationId) <span class="required">*</span></label>
							<InputNumber id="station" class="input" @bind-Value="rental.StationId" />
							<ValidationMessage For="@(() => rental.StationId)" class="validation-message" />
						</div>

						<div class="form-group">
							<label for="status">Trạng thái</label>
							<InputSelect id="status" class="input" @bind-Value="rental.RentalStatusTienDtid">
								<option value="">-- Chọn trạng thái --</option>
								@if (rentalStatuses != null)
								{
									@foreach (var status in rentalStatuses)
									{
										<option value="@status.RentalStatusTienDtid">@status.StatusName</option>
									}
								}
							</InputSelect>
						</div>

						<div class="form-group">
							<label for="start">Thời gian bắt đầu <span class="required">*</span></label>
							<InputDate id="start" class="input" @bind-Value="rental.StartTime" />
							<ValidationMessage For="@(() => rental.StartTime)" class="validation-message" />
						</div>

						<div class="form-group">
							<label for="plannedEnd">Thời gian dự kiến kết thúc</label>
							<InputDate id="plannedEnd" class="input" @bind-Value="rental.PlannedEndTime" />
						</div>

						<div class="form-group">
							<label for="end">Thời gian kết thúc</label>
							<InputDate id="end" class="input" @bind-Value="rental.EndTime" />
						</div>

						<div class="form-group">
							<label for="totalAmount">Tổng tiền</label>
							<InputNumber id="totalAmount" class="input" @bind-Value="rental.TotalAmount" />
							<ValidationMessage For="@(() => rental.TotalAmount)" class="validation-message" />
						</div>

						<div class="form-group">
							<label for="securityDeposit">Tiền đặt cọc <span class="required">*</span></label>
							<InputNumber id="securityDeposit" class="input" @bind-Value="rental.SecurityDeposit" />
							<ValidationMessage For="@(() => rental.SecurityDeposit)" class="validation-message" />
						</div>

							<div class="form-group">
								<label for="isCompleted">Hoàn thành</label>
								<InputCheckbox id="isCompleted" class="input" @bind-Value="IsCompleted" />
							</div>
						
							<div class="form-group">
								<label for="isActive">Hoạt động</label>
								<InputCheckbox id="isActive" class="input" @bind-Value="IsActive" />
							</div>						
						<div class="form-group full-width">
							<label for="note">Ghi chú</label>
							<InputTextArea id="note" class="textarea" @bind-Value="rental.Note" />
							<ValidationMessage For="@(() => rental.Note)" class="validation-message" />
						</div>
					</div>
				</div>

				<div class="card-footer">
					<button type="submit" class="btn primary" disabled="@isSubmitting">
						@if (isSubmitting)
						{
							<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
							<span> Đang lưu...</span>
						}
						else
						{
							<span>Lưu</span>
						}
					</button>
					<button type="button" class="btn ghost" @onclick="ResetForm" disabled="@isSubmitting">Xóa</button>
				</div>
			</EditForm>
		}
	</div>
	<div class="preview">
		<h4>Xem trước</h4>
		<div class="preview-card">
			<div><strong>Bắt đầu:</strong> @rental.StartTime.ToString("g", CultureInfo.CurrentCulture)</div>
			<div><strong>Dự kiến kết thúc:</strong> @(rental.PlannedEndTime?.ToString("g", CultureInfo.CurrentCulture) ?? "-")</div>
			<div><strong>Đặt cọc:</strong> @string.Format(CultureInfo.CurrentCulture, "{0:C}", rental.SecurityDeposit)</div>
			<div><strong>Ghi chú:</strong> @rental.Note</div>
		</div>
	</div>
</div>

@code {
	[Parameter] public int? Id { get; set; }

	private RentalsTienDt rental = new RentalsTienDt
	{
		StartTime = DateTime.Now,
		SecurityDeposit = 0m,
		IsActive = true,
		Note = "",  // Initialize Note to prevent null
		UserAccountId = 0,  // Set to 0 to trigger validation
		VehicleId = 0,  // Set to 0 to trigger validation
		StationId = 0   // Set to 0 to trigger validation
	};
	private string? errorMessage;
	private string? validationError;
	private bool isLoading;
	private bool isSubmitting;
	private List<RentalStatusesTienDt>? rentalStatuses;
	
	protected override async Task OnInitializedAsync()
	{
		isLoading = true;
		try
		{
			rentalStatuses = await GraphQLClient.GetRentalStatusesTienDtsAsync();
			if (Id.HasValue)
			{
				rental = await GraphQLClient.GetRentalByIdAsync(Id.Value) ?? new RentalsTienDt();
			}
		}
		catch (Exception ex)
		{
			errorMessage = "Không thể tải dữ liệu: " + ex.Message;
		}
		finally
		{
			isLoading = false;
		}
	}

	private async Task HandleValidSubmit()
	{
		// Additional validation
		if (rental.UserAccountId <= 0)
		{
			validationError = "Vui lòng nhập User Account ID hợp lệ (> 0)";
			return;
		}
		
		if (rental.VehicleId <= 0)
		{
			validationError = "Vui lòng nhập Vehicle ID hợp lệ (> 0)";
			return;
		}
		
		if (rental.StationId <= 0)
		{
			validationError = "Vui lòng nhập Station ID hợp lệ (> 0)";
			return;
		}
		
		if (rental.SecurityDeposit < 0)
		{
			validationError = "Tiền đặt cọc phải >= 0";
			return;
		}

		isSubmitting = true;
		validationError = null;
		
		try
		{
			errorMessage = null;
			if (Id.HasValue)
			{
				await GraphQLClient.UpdateRentalAsync(rental);
			}
			else
			{
				await GraphQLClient.CreateRentalsAsync(rental);
			}
			Navigation.NavigateTo("/RentalsTienDts/RentalsTienDtsList"); // Navigate to list page
		}
		catch (Exception ex)
		{
			errorMessage = "Lỗi khi lưu: " + ex.Message;
		}
		finally
		{
			isSubmitting = false;
		}
	}

	private bool IsCompleted
	{
		get => rental.IsCompleted ?? false;
		set => rental.IsCompleted = value;
	}

	private bool IsActive
	{
		get => rental.IsActive ?? false;
		set => rental.IsActive = value;
	}

	private void ResetForm()
	{
		rental = new RentalsTienDt
		{
			StartTime = DateTime.Now,
			SecurityDeposit = 0m,
			IsActive = true,
			Note = "",
			UserAccountId = 0,
			VehicleId = 0,
			StationId = 0
		};
		errorMessage = null;
		validationError = null;
	}
}
