@page "/RentalsTienDts/RentalsTienDtForm/{id:int?}"
@using EVRental.BlazorWebApp.TienDT.Models
@using EVRental.BlazorWebApp.TienDT.GraphQLClients
@using System.Globalization
@inject GraphQLConsumers GraphQLClient
@inject NavigationManager Navigation

<div class="rental-form-container">
	<div class="card">
		<div class="card-header">
			<h3>@(Id.HasValue ? "Chỉnh sửa thuê xe" : "Đăng ký thuê xe")</h3>
			<p class="subtitle">Nhập thông tin thuê xe — đơn giản, nhanh chóng và rõ ràng</p>
		</div>

		@if (!string.IsNullOrEmpty(errorMessage))
		{
			<div class="alert error">
				@errorMessage
			</div>
		}

		@if (isLoading)
		{
			<div class="loading">Đang tải...</div>
		}
		else
		{
			<EditForm Model="rental" OnValidSubmit="HandleValidSubmit">
				<DataAnnotationsValidator />
				<ValidationSummary />

				<div class="card-body">
					<div class="grid">
						<div class="form-group">
							<label for="userAccount">Người thuê (UserAccountId)</label>
							<InputNumber id="userAccount" class="input" @bind-Value="rental.UserAccountId" />
						</div>

						<div class="form-group">
							<label for="vehicle">Xe (VehicleId)</label>
							<InputNumber id="vehicle" class="input" @bind-Value="rental.VehicleId" />
						</div>

						<div class="form-group">
							<label for="station">Trạm (StationId)</label>
							<InputNumber id="station" class="input" @bind-Value="rental.StationId" />
						</div>

						<div class="form-group">
							<label for="start">Thời gian bắt đầu</label>
							<InputDate id="start" class="input" @bind-Value="rental.StartTime" />
						</div>

						<div class="form-group">
							<label for="plannedEnd">Thời gian dự kiến kết thúc</label>
							<InputDate id="plannedEnd" class="input" @bind-Value="rental.PlannedEndTime" />
						</div>

						<div class="form-group">
							<label for="security">Tiền đặt cọc</label>
							<InputNumber id="security" class="input" @bind-Value="rental.SecurityDeposit" />
						</div>

						<div class="form-group full-width">
							<label for="note">Ghi chú</label>
							<InputTextArea id="note" class="textarea" @bind-Value="rental.Note" />
						</div>
					</div>
				</div>

				<div class="card-footer">
					<button type="submit" class="btn primary" disabled="@isSubmitting">Lưu</button>
					<button type="button" class="btn ghost" @onclick="ResetForm">Xóa</button>
				</div>
			</EditForm>
		}
	</div>
	<div class="preview">
		<h4>Xem trước</h4>
		<div class="preview-card">
			<div><strong>Bắt đầu:</strong> @rental.StartTime.ToString("g", CultureInfo.CurrentCulture)</div>
			<div><strong>Dự kiến kết thúc:</strong> @(rental.PlannedEndTime?.ToString("g", CultureInfo.CurrentCulture) ?? "-")</div>
			<div><strong>Đặt cọc:</strong> @string.Format(CultureInfo.CurrentCulture, "{0:C}", rental.SecurityDeposit)</div>
			<div><strong>Ghi chú:</strong> @rental.Note</div>
		</div>
	</div>
</div>

@code {
	[Parameter] public int? Id { get; set; }

	private RentalsTienDt rental = new RentalsTienDt
	{
		StartTime = DateTime.Now,
		SecurityDeposit = 0m,
		IsActive = true
	};

	private string? errorMessage;
	private bool isLoading;
	private bool isSubmitting;

	protected override async Task OnInitializedAsync()
	{
		if (Id.HasValue)
		{
			isLoading = true;
			try
			{
				rental = await GraphQLClient.GetRentalByIdAsync(Id.Value) ?? new RentalsTienDt();
			}
			catch (Exception ex)
			{
				errorMessage = "Không thể tải dữ liệu: " + ex.Message;
			}
			finally
			{
				isLoading = false;
			}
		}
	}

	private async Task HandleValidSubmit()
	{
		isSubmitting = true;
		try
		{
			errorMessage = null;
			if (Id.HasValue)
			{
				await GraphQLClient.UpdateRentalAsync(rental);
			}
			else
			{
				await GraphQLClient.CreateRentalsAsync(rental);
			}
			Navigation.NavigateTo("/RentalsTienDts"); // Navigate to list page
		}
		catch (Exception ex)
		{
			errorMessage = "Lỗi khi lưu: " + ex.Message;
		}
		finally
		{
			isSubmitting = false;
		}
	}

	private void ResetForm()
	{
		rental = new RentalsTienDt
		{
			StartTime = DateTime.Now,
			SecurityDeposit = 0m,
			IsActive = true
		};
		errorMessage = null;
	}
}
