@page "/RentalsTienDts/RentalsTienDtsList"
@using EVRental.BlazorWebApp.TienDT.Models
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject EVRental.BlazorWebApp.TienDT.GraphQLClients.GraphQLConsumers _graphQLConsumers
@inject NavigationManager NavigationManager

<style>
    .rentals-header {
        background: linear-gradient(135deg, var(--vintage-primary) 0%, var(--vintage-secondary) 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .rentals-header h1 {
        color: white;
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
    }

    .rental-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        border-left: 4px solid var(--vintage-primary);
    }

    .rental-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .rental-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--vintage-border);
    }

    .rental-id {
        font-size: 1.25rem;
        font-weight: bold;
        color: var(--vintage-text);
    }

    .status-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .active-badge {
        background-color: #d4edda;
        color: #155724;
    }

    .inactive-badge {
        background-color: #f8d7da;
        color: #721c24;
    }

    .rental-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
    }

    .detail-label {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 500;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .detail-value {
        font-size: 1rem;
        color: var(--vintage-text);
        font-weight: 600;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-modern {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 5px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-view {
        background-color: var(--vintage-info);
        color: white;
    }

    .btn-view:hover {
        background-color: #8fb3b3;
        transform: scale(1.05);
    }

    .btn-edit {
        background-color: var(--vintage-warning);
        color: white;
    }

    .btn-edit:hover {
        background-color: #d5a466;
        transform: scale(1.05);
    }

    .btn-delete {
        background-color: var(--vintage-danger);
        color: white;
    }

    .btn-delete:hover {
        background-color: #b56e6f;
        transform: scale(1.05);
    }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
        padding: 1rem;
    }

    .modal-content {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.2);
        max-width: 420px;
        width: 100%;
        padding: 2rem;
        text-align: center;
    }

    .modal-content h3 {
        margin-bottom: 1rem;
        font-size: 1.35rem;
        color: var(--vintage-text);
    }

    .modal-content p {
        margin: 0;
        color: #555555;
    }

    .modal-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.75rem;
    }

    .btn-cancel {
        background-color: #e0e0e0;
        color: #333333;
    }

    .btn-cancel:hover {
        background-color: #d5d5d5;
        transform: scale(1.05);
    }

    .btn-create {
        background-color: var(--vintage-primary);
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-create:hover {
        background-color: var(--vintage-secondary);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transform: translateY(-2px);
    }

    .pagination-modern {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-top: 2rem;
    }

    .page-link {
        color: var(--vintage-text);
        background-color: white;
        border: 1px solid var(--vintage-border);
        margin: 0 0.25rem;
        border-radius: 5px;
    }

    .page-link:hover {
        background-color: var(--vintage-border);
        border-color: var(--vintage-secondary);
    }

    .page-item.active .page-link {
        background-color: var(--vintage-primary);
        border-color: var(--vintage-primary);
        color: white;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

    .search-section {
        margin-bottom: 2rem;
    }

    .search-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 4px solid var(--vintage-primary);
    }

    .search-title {
        margin: 0 0 1.5rem;
        color: var(--vintage-text);
        font-size: 1.5rem;
        font-weight: 600;
    }

    .search-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        align-items: end;
    }

    .search-field {
        display: flex;
        flex-direction: column;
    }

    .search-field label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #495057;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .search-field .form-control {
        padding: 0.75rem 1rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }

    .search-field .form-control:focus {
        outline: none;
        border-color: var(--vintage-primary);
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-actions {
        display: flex;
        gap: 0.75rem;
    }

    .btn-search, .btn-clear {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-search {
        background: var(--vintage-primary);
        color: white;
        flex: 1;
    }

    .btn-search:hover {
        background: var(--vintage-secondary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-clear {
        background: #6c757d;
        color: white;
        flex: 1;
    }

    .btn-clear:hover {
        background: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
</style>

@if (_isLoading)
{
    <div class="loading-overlay">
        <div class="spinner"></div>
    </div>
}

<div class="rentals-header">
    <div class="d-flex justify-content-between align-items-center">
        <h1>🚗 Rental Management</h1>
        <button class="btn-create" @onclick='() => NavigationManager.NavigateTo("/RentalsTienDts/RentalsTienDtForm")'>
            ➕ Create New Rental
        </button>
    </div>
</div>

<div class="search-section">
    <div class="search-card">
        <h3 class="search-title">🔍 Search Rentals</h3>
        <div class="search-form">
            <div class="search-field">
                <label>Note</label>
                <input type="text" class="form-control" @bind="searchNote" placeholder="Search by note..." />
            </div>
            <div class="search-field">
                <label>Security Deposit</label>
                <input type="number" class="form-control" @bind="searchSecurityDeposit" placeholder="Enter amount..." />
            </div>
            <div class="search-field">
                <label>Status Name</label>
                <input type="text" class="form-control" @bind="searchStatusName" placeholder="Search by status..." />
            </div>
            <div class="search-actions">
                <button class="btn-search" @onclick="SearchRentals">
                    🔎 Search
                </button>
                <button class="btn-clear" @onclick="ClearSearch">
                    🔄 Clear
                </button>
            </div>
        </div>
    </div>
</div>

@if (RentalsTienDts == null)
{
    <p class="empty-state"><em>Loading...</em></p>
}
else if (RentalsTienDts.Count == 0)
{
    <div class="empty-state">
        <h3>No rentals found</h3>
        <p>Start by creating a new rental</p>
    </div>
}
else
{
    <div class="rentals-list">
        @foreach (var item in PaginatedRentals)
        {
            <div class="rental-card">
                <div class="rental-card-header">
                    <span class="rental-id">Rental #@item.RentalTienDtid</span>
                    <span class="status-badge @(item.IsActive.HasValue && item.IsActive.Value ? "active-badge" : "inactive-badge")">
                        @(item.IsActive.HasValue && item.IsActive.Value ? "🟢 Active" : "🔴 Inactive")
                    </span>
                </div>

                <div class="rental-details">
                    <div class="detail-item">
                        <span class="detail-label">👤 User Account</span>
                        <span class="detail-value">@item.UserAccountId</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">🚙 Vehicle</span>
                        <span class="detail-value">@item.VehicleId</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">💰 Total Amount</span>
                        <span class="detail-value">@(item.TotalAmount.HasValue ? item.TotalAmount.Value.ToString("C") : "N/A")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">🔒 Security Deposit</span>
                        <span class="detail-value">@item.SecurityDeposit.ToString("C")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">📅 Created Date</span>
                        <span class="detail-value">@(item.CreatedDate.HasValue ? item.CreatedDate.Value.ToString("MMM dd, yyyy") : "N/A")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">📊 Status</span>
                        <span class="detail-value">@GetStatusName(item.RentalStatusTienDtid)</span>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(item.Note))
                {
                    <div class="detail-item mb-3">
                        <span class="detail-label">📝 Note</span>
                        <span class="detail-value">@item.Note</span>
                    </div>
                }

                <div class="action-buttons">
                    <button class="btn-modern btn-view" @onclick="() => NavigateToDetail(item.RentalTienDtid)">
                        👁️ View Details
                    </button>
                    <button class="btn-modern btn-edit" @onclick="() => NavigateToUpdate(item.RentalTienDtid)">
                        ✏️ Edit
                    </button>
                    <button class="btn-modern btn-delete" @onclick="() => NavigateToDetailForDelete(item.RentalTienDtid)">
                        🗑️ Delete
                    </button>
                </div>
            </div>
        }
    </div>
    
    @if (totalPages > 1)
    {
        <div class="pagination-modern">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                            Previous
                        </button>
                    </li>
                    
                    @if (totalPages <= 7)
                    {
                        @for (int i = 1; i <= totalPages; i++)
                        {
                            int pageNumber = i;
                            <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                                <button class="page-link" @onclick="() => GoToPage(pageNumber)">
                                    @pageNumber
                                </button>
                            </li>
                        }
                    }
                    else
                    {
                        @if (currentPage > 3)
                        {
                            <li class="page-item">
                                <button class="page-link" @onclick="() => GoToPage(1)">1</button>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        
                        @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                        {
                            int pageNumber = i;
                            <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                                <button class="page-link" @onclick="() => GoToPage(pageNumber)">
                                    @pageNumber
                                </button>
                            </li>
                        }
                        
                        @if (currentPage < totalPages - 2)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                            <li class="page-item">
                                <button class="page-link" @onclick="() => GoToPage(totalPages)">@totalPages</button>
                            </li>
                        }
                    }
                    
                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                            Next
                        </button>
                    </li>
                </ul>
            </nav>
            
            <div class="text-center mt-2">
                <span class="text-muted">
                    Page @currentPage of @totalPages (Total items: @(RentalsTienDts?.Count ?? 0))
                </span>
            </div>
            
            <div class="text-center mt-2">
                <label class="me-2">Items per page:</label>
                <select class="form-select form-select-sm d-inline-block w-auto" @onchange="ChangePageSize">
                    <option value="5">5</option>
                    <option value="10" selected="@(pageSize == 10)">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </div>
        </div>
    }
}

@code {
    private List<RentalsTienDt>? RentalsTienDts;
    private List<RentalStatusesTienDt>? rentalStatuses;
    private Dictionary<int, string> statusMap = new Dictionary<int, string>();
    private bool _isLoading = false;
    
    // Pagination variables
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 0;
    
    // Search variables
    private string? searchNote;
    private decimal? searchSecurityDeposit;
    private string? searchStatusName;
    private bool isSearching = false;
    
    private List<RentalsTienDt> PaginatedRentals
    {
        get
        {
            if (RentalsTienDts == null) return new List<RentalsTienDt>();
            
            return RentalsTienDts
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        try
        {
            RentalsTienDts = await _graphQLConsumers.GetRentalsAsync();
            rentalStatuses = await _graphQLConsumers.GetRentalStatusesTienDtsAsync();
            statusMap = rentalStatuses.ToDictionary(s => s.RentalStatusTienDtid, s => s.StatusName);
            
            // Calculate total pages
            if (RentalsTienDts != null && RentalsTienDts.Count > 0)
            {
                totalPages = (int)Math.Ceiling((double)RentalsTienDts.Count / pageSize);
            }
        }
        catch (Exception e)
        {
            // Proper error handling would be better here
            Console.WriteLine($"Error loading data: {e.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetStatusName(int? statusId)
    {
        if (statusId.HasValue && statusMap.ContainsKey(statusId.Value))
        {
            return statusMap[statusId.Value];
        }
        return "N/A";
    }

    private void NavigateToDetail(int rentalId)
    {
        NavigationManager.NavigateTo($"/RentalsTienDts/RentalsTienDtDetail/{rentalId}");
    }

    private void NavigateToUpdate(int rentalId)
    {
        NavigationManager.NavigateTo($"/RentalsTienDts/RentalsTienDtForm/{rentalId}");
    }

    private void NavigateToDetailForDelete(int rentalId)
    {
        // Navigate to detail page for delete confirmation
        NavigationManager.NavigateTo($"/RentalsTienDts/RentalsTienDtDetail/{rentalId}");
    }

    private void GoToPage(int pageNumber)
    {
        if (pageNumber >= 1 && pageNumber <= totalPages)
        {
            currentPage = pageNumber;
            StateHasChanged();
        }
    }

    private void ChangePageSize(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var newPageSize))
        {
            pageSize = newPageSize;
            currentPage = 1; // Reset to first page
            
            // Recalculate total pages
            if (RentalsTienDts != null && RentalsTienDts.Count > 0)
            {
                totalPages = (int)Math.Ceiling((double)RentalsTienDts.Count / pageSize);
            }
            
            StateHasChanged();
        }
    }

    private async Task SearchRentals()
    {
        _isLoading = true;
        isSearching = true;
        currentPage = 1; // Reset to first page on new search
        
        try
        {
            var searchResponse = await _graphQLConsumers.SearchRentalsAsync(
                searchNote,
                searchSecurityDeposit,
                searchStatusName,
                currentPage,
                pageSize
            );
            
            RentalsTienDts = searchResponse.Items;
            totalPages = searchResponse.TotalPages;
            currentPage = searchResponse.CurrentPage;
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error searching rentals: {e.Message}");
            RentalsTienDts = new List<RentalsTienDt>();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ClearSearch()
    {
        searchNote = null;
        searchSecurityDeposit = null;
        searchStatusName = null;
        isSearching = false;
        currentPage = 1;
        
        await LoadAllRentals();
    }

    private async Task LoadAllRentals()
    {
        _isLoading = true;
        try
        {
            RentalsTienDts = await _graphQLConsumers.GetRentalsAsync();
            
            // Recalculate total pages
            if (RentalsTienDts != null && RentalsTienDts.Count > 0)
            {
                totalPages = (int)Math.Ceiling((double)RentalsTienDts.Count / pageSize);
            }
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error loading rentals: {e.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}
