@page "/RentalsTienDts/RentalsTienDtsList"
@using EVRental.BlazorWebApp.TienDT.Models
@inject EVRental.BlazorWebApp.TienDT.GraphQLClients.GraphQLConsumers _graphQLConsumers
@inject NavigationManager NavigationManager

@if (_isLoading)
{
    <div class="loading-overlay">
        <div class="spinner"></div>
    </div>
}

<h1>RentalsTienDtList</h1>

@if (RentalsTienDts == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <a href="/RentalsTienDts/RentalsTienDtForm" class="btn btn-primary mb-3">Create New Rental</a>
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>User Account</th>
                <th>Vehicle</th>
                <th>Total Amount</th>
                <th>Security Deposit</th>
                <th>Note</th>
                <th>Created Date</th>
                <th>Active</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in PaginatedRentals)
            {
                <tr>
                    <td>@item.RentalTienDtid</td>
                    <td>@item.UserAccountId</td>
                    <td>@item.VehicleId</td>
                    <td>@(item.TotalAmount.HasValue ? item.TotalAmount.Value.ToString("C") : string.Empty)</td>
                    <td>@item.SecurityDeposit.ToString("C")</td>
                    <td>@(string.IsNullOrEmpty(item.Note) ? "" : item.Note)</td>
                    <td>@(item.CreatedDate.HasValue ? item.CreatedDate.Value.ToString("g") : string.Empty)</td>
                    <td>@(item.IsActive.HasValue ? (item.IsActive.Value ? "Yes" : "No") : "")</td>
                    <td>@GetStatusName(item.RentalStatusTienDtid)</td>
                    <td>
                        <button class="btn btn-info btn-sm" @onclick="() => NavigateToDetail(item.RentalTienDtid)">Detail</button>
                        <button class="btn btn-warning btn-sm" @onclick="() => NavigateToUpdate(item.RentalTienDtid)">Update</button>
                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteRental(item.RentalTienDtid)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    
    @if (totalPages > 1)
    {
        <div class="pagination-container mt-3">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                            Previous
                        </button>
                    </li>
                    
                    @if (totalPages <= 7)
                    {
                        @for (int i = 1; i <= totalPages; i++)
                        {
                            int pageNumber = i;
                            <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                                <button class="page-link" @onclick="() => GoToPage(pageNumber)">
                                    @pageNumber
                                </button>
                            </li>
                        }
                    }
                    else
                    {
                        @if (currentPage > 3)
                        {
                            <li class="page-item">
                                <button class="page-link" @onclick="() => GoToPage(1)">1</button>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        
                        @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                        {
                            int pageNumber = i;
                            <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                                <button class="page-link" @onclick="() => GoToPage(pageNumber)">
                                    @pageNumber
                                </button>
                            </li>
                        }
                        
                        @if (currentPage < totalPages - 2)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                            <li class="page-item">
                                <button class="page-link" @onclick="() => GoToPage(totalPages)">@totalPages</button>
                            </li>
                        }
                    }
                    
                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                            Next
                        </button>
                    </li>
                </ul>
            </nav>
            
            <div class="text-center mt-2">
                <span class="text-muted">
                    Page @currentPage of @totalPages (Total items: @(RentalsTienDts?.Count ?? 0))
                </span>
            </div>
            
            <div class="text-center mt-2">
                <label class="me-2">Items per page:</label>
                <select class="form-select form-select-sm d-inline-block w-auto" @onchange="ChangePageSize">
                    <option value="5">5</option>
                    <option value="10" selected="@(pageSize == 10)">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </div>
        </div>
    }
}

@code {
    private List<RentalsTienDt>? RentalsTienDts;
    private List<RentalStatusesTienDt>? rentalStatuses;
    private Dictionary<int, string> statusMap = new Dictionary<int, string>();
    private bool _isLoading = false;
    
    // Pagination variables
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 0;
    
    private List<RentalsTienDt> PaginatedRentals
    {
        get
        {
            if (RentalsTienDts == null) return new List<RentalsTienDt>();
            
            return RentalsTienDts
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        try
        {
            RentalsTienDts = await _graphQLConsumers.GetRentalsAsync();
            rentalStatuses = await _graphQLConsumers.GetRentalStatusesTienDtsAsync();
            statusMap = rentalStatuses.ToDictionary(s => s.RentalStatusTienDtid, s => s.StatusName);
            
            // Calculate total pages
            if (RentalsTienDts != null && RentalsTienDts.Count > 0)
            {
                totalPages = (int)Math.Ceiling((double)RentalsTienDts.Count / pageSize);
            }
        }
        catch (Exception e)
        {
            // Proper error handling would be better here
            Console.WriteLine($"Error loading data: {e.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetStatusName(int? statusId)
    {
        if (statusId.HasValue && statusMap.ContainsKey(statusId.Value))
        {
            return statusMap[statusId.Value];
        }
        return "N/A";
    }

    private void NavigateToDetail(int rentalId)
    {
        NavigationManager.NavigateTo($"/RentalsTienDts/RentalsTienDtDetail/{rentalId}");
    }

    private void NavigateToUpdate(int rentalId)
    {
        NavigationManager.NavigateTo($"/RentalsTienDts/RentalsTienDtForm/{rentalId}");
    }

    private async Task DeleteRental(int rentalId)
    {
        _isLoading = true;
        try
        {
            var success = await _graphQLConsumers.DeleteRentalAsync(rentalId);
            if (success)
            {
                // Refresh the list after deletion
                RentalsTienDts = await _graphQLConsumers.GetRentalsAsync();
                
                // Recalculate total pages
                if (RentalsTienDts != null && RentalsTienDts.Count > 0)
                {
                    totalPages = (int)Math.Ceiling((double)RentalsTienDts.Count / pageSize);
                    // If current page is now beyond total pages, go to last page
                    if (currentPage > totalPages)
                    {
                        currentPage = totalPages;
                    }
                }
            }
            else
            {
                // Handle deletion failure
                Console.WriteLine($"Failed to delete rental with ID: {rentalId}");
            }
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error deleting rental: {e.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged(); // Notify Blazor to re-render the component
        }
    }

    private void GoToPage(int pageNumber)
    {
        if (pageNumber >= 1 && pageNumber <= totalPages)
        {
            currentPage = pageNumber;
            StateHasChanged();
        }
    }

    private void ChangePageSize(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var newPageSize))
        {
            pageSize = newPageSize;
            currentPage = 1; // Reset to first page
            
            // Recalculate total pages
            if (RentalsTienDts != null && RentalsTienDts.Count > 0)
            {
                totalPages = (int)Math.Ceiling((double)RentalsTienDts.Count / pageSize);
            }
            
            StateHasChanged();
        }
    }
}
